# 变更日志

## [未发布]

### 新增
- 查询历史页面自动加载数据
- 查询历史页面过滤掉未命名查询，只显示已保存的查询
- 优化查询结果处理逻辑，支持处理各种后端API返回格式
  - 增强对嵌套数据结构的处理能力
  - 正确识别并处理带有 fields 字段的查询结果
  - 支持 API 标准包装格式 (success + data)
- 修复顶部导航"查询"链接指向问题，确保链接到查询历史页面
- 适配API标准化
  - 修改数据源获取接口(getDataSources)，支持标准分页响应结构
  - 修改收藏查询接口(getFavorites)，支持标准响应格式
  - 新增标准化的查询列表获取接口(getQueries)
  - 所有分页接口使用统一的page/size参数
  - 所有列表响应使用统一的success+data+items+pagination结构
  - 增强字段兼容性，支持多种后端命名约定
- 实现全局Mock模式
  - 添加全局fetch拦截器，拦截所有API请求
  - 添加全局axios拦截器，拦截并模拟所有ajax请求
  - 防止Object.prototype污染，解决locale方法冲突
  - 支持Mock模式下前端独立运行，无需后端服务
  - 完整实现数据源、元数据、查询和集成相关API的Mock数据
- 修复直接使用fetch函数调用后端API的问题

### 优化
- 优化"保存查询"弹窗布局，采用更合理的行式设计
  - 增加弹窗宽度，提供更宽敞的操作空间
  - 第一行放置查询名称和数据源
  - 第二行放置标签和查询类型
  - 第三行放置查询内容
  - 第四行放置备注说明
  - 整体排版更加美观，符合宽屏阅读习惯
- 改进API调用方式，移除所有代理配置
  - 删除Vite代理配置，避免代理导致的网络问题
  - 修改API基础URL处理，使用直接URL调用后端服务
  - 规范化URL格式，确保无斜杠结尾
  - 解决因代理导致的保存表单回显问题
- 修改开发服务器端口配置
  - 将开发服务器端口从8081更改为8080
  - 相应更新CSP配置中的连接源设置
  - 提高与其他服务的兼容性
- 改进API数据获取逻辑，确保不使用模拟数据
  - 修改API错误处理方式，移除使用模拟数据作为回退的逻辑
  - 增强日志输出，便于API调试和故障排查
  - 修复查询执行计划和建议获取方法，确保数据真实性
  - 优化显示内容，显示真实的API响应数据
  - 为API调用添加详细的请求和响应日志
- 确认并规范化删除查询接口的正确实现
  - 验证删除查询操作使用标准 DELETE /api/queries/:id 接口
  - 确保前后端接口一致性
  - 统一错误处理逻辑
  - 验证环境配置中的API基础URL设置正确性
- 精简查询编辑页面界面
  - 移除了顶部冗余的保存和执行按钮
  - 保留了收藏功能，便于用户快速收藏常用查询
  - 保留查询名称和版本信息
  - 减少界面元素重复，提高用户体验
- 重构查询执行流程
  - 优化代码结构，将查询执行拆分为多个专注的小函数
  - 增强错误处理，提供更详细的错误提示
  - 添加查询成功后自动滚动到结果区域功能
  - 改进SQL验证逻辑，更精确地检测常见错误
  - 根据查询类型智能选择正确的执行路径
- 完善类型定义系统
  - 修复QueryResult类型，确保fields字段正确定义
  - 增强API响应处理逻辑，统一处理各种返回格式
  - 为所有函数添加清晰的返回类型
  - 优化查询状态管理逻辑，确保类型安全
  - 新增QueryBuilderState接口定义，完善查询构建器类型系统
  - 新增QueryExecution接口，标准化执行记录数据结构
- 增强测试环境支持
  - 重构模拟API，使其与真实API保持一致的参数和返回格式
  - 新增模拟查询执行历史功能，方便前端开发测试
  - 为模拟数据添加丰富的数据集，便于功能展示和测试
- API字段映射增强
  - 支持后端使用sqlContent字段传输查询内容
  - 支持后端使用startTime/endTime替代createdAt/updatedAt
  - 支持后端使用duration替代executionTime
  - 支持多种错误字段命名(errorMessage/error)
  - 通过智能字段映射确保不同版本API无缝工作

### 修复
- 修复数据源连接测试功能在Mock模式下的问题
  - 增强testConnection方法，支持Mock模式下的连接测试
  - 增强testExistingConnection方法，支持Mock模式下的现有数据源连接测试
  - 添加模拟延迟和服务器版本信息，提供更真实的测试体验
  - 解决了404 Not Found错误，确保在Mock模式下可以正常工作
- 修复数据源元数据同步功能在Mock模式下的404错误问题
  - 增强syncMetadata方法，支持Mock模式下的元数据同步操作
  - 添加模拟延迟和同步结果数据，提供更真实的同步体验
  - 解决了同步元数据时出现的404 Not Found和JSON解析错误
- 修复元数据浏览器组件在Mock模式下的解析错误问题
  - 增强getTableMetadata方法，支持Mock模式下的表元数据获取
  - 增强getTableColumns方法，支持Mock模式下的表列信息获取
  - 解决了"SyntaxError: Unexpected token '<', "<!DOCTYPE "... is not valid JSON"错误
  - 添加符合接口定义的模拟数据，确保类型安全
- 修复表数据预览功能在Mock模式下的JSON解析错误问题
  - 增强getTableDataPreview方法，支持Mock模式下的数据预览
  - 添加模拟表格数据、列定义和分页信息
  - 解决了"SyntaxError: Unexpected token '<', "<!DOCTYPE "... is not valid JSON"错误
  - 实现了分页功能，支持动态生成不同页的数据
- 修复查询版本功能在Mock模式下的404错误问题
  - 增强versionService.getVersion方法，支持Mock模式下的版本详情获取
  - 增强versionService中所有方法，包括getVersions、createVersion、updateVersion等
  - 添加模拟版本数据和生成逻辑，支持版本的创建、更新、发布和废弃操作
  - 解决了"GET /api/queries/versions/{id} 404 (Not Found)"错误
- 修复确认对话框属性不匹配问题
  - 修复ConfirmModal组件缺少required prop "open"的警告
  - 将modal.ts中createConfirm方法传递的visible属性改为open属性
  - 确保属性名称与组件期望的prop名称一致
- 修复模块导入错误
  - 删除对不存在的PaginatedResponse和PaginatedRequest类型的导入
  - 解决"The requested module '/src/types/common.ts' does not provide an export named 'PaginatedRequest'"错误
- 修复查询列表和查询详情页面错误
  - 解决获取查询列表时出现 "SyntaxError: Unexpected token '<', "<!DOCTYPE "... is not valid JSON" 错误
  - 修复查询详情页面加载时显示 "getQueryExecutionHistory is not a function" 的错误
  - 完善了查询服务(queryService)实现，添加了缺失的 getQueryExecutionHistory 函数
  - 增强了所有查询相关API在mock模式下的模拟数据支持，包括
    - getQueries（获取查询列表）
    - getQuery（获取单个查询详情）
    - getQueryExecutionHistory（获取查询执行历史）
    - getQueryPlan（获取查询执行计划）
    - getQuerySuggestions（获取查询优化建议）
    - getQueryVisualization（获取查询可视化配置）
  - 提高了前端代码健壮性，确保在API错误情况下有合理的降级策略
- 修复查询历史页分页显示问题
- 修复删除查询后分页计算错误的问题
- 解决执行查询后结果显示不完整的问题
- 修复分页参数处理中可能的undefined值问题，增强代码健壮性
- 优化错误处理逻辑，添加统一的API错误响应处理
- 增强localStorage操作的错误处理，提供详细的错误分类和诊断信息
- 修复API调用配置，确保正确使用代理和真实API
  - 修改getApiBaseUrl函数以支持多种环境变量和默认值
  - 增强API基础URL检测逻辑，适应不同端口情况
  - 改进日志输出，方便调试API调用问题
- 修复后端元数据服务getTableList函数返回类型错误
- 修复SQL编辑器界面查询构建器选项卡中的表和字段列表不显示问题
  - 统一前后端API响应格式处理
  - 适配后端返回的新数据结构
  - 修复表格数据渲染逻辑
- 修复数据源服务API请求地址问题
  - 统一使用getApiBaseUrl方法获取基础URL
  - 正确拼接完整API路径/api/datasources和/api/metadata
  - 解决SyntaxError: Unexpected token '<', "<!DOCTYPE "... is not valid JSON错误
- 修复保存查询弹窗数据回显问题
  - 优化SaveQueryModal组件的watch函数
  - 确保每次弹窗打开时正确初始化表单数据
  - 改进queryText字段的回显和编辑功能
  - 添加日志输出便于调试回显问题
- 修复查询历史删除功能
  - 更新删除查询历史接口，使用/api/queries/history/{id}
  - 添加专用deleteQueryHistory方法到查询服务和store
  - 修改QueryHistory组件使用新的删除方法
  - 确保正确处理API响应和错误情况
- 修复查询执行计划不显示问题

## 2023-07-11

### 改进
- 查询历史页面现在会在组件挂载时自动加载数据
- 查询历史页面不再显示未命名查询，只显示已保存的查询
  - 过滤掉名称以"未命名查询:"开头或没有名称的查询
  - 分页显示和数据统计基于过滤后的数据

### 修复
- 修复了在 QueryEditor.vue 中对 undefined 或 null 值调用 trim() 方法导致的错误
  - 在 getExecuteButtonTooltip 函数中增加了空值检查
  - 在 canExecuteQuery 计算属性中增加了空值检查
  - 修复了 SaveQueryParams 中 id 字段类型不匹配的问题
- 修复了顶部导航中的路由问题，确保查询菜单项指向正确的历史页面