# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- 查询模块联调分支创建
  - 修复LIMIT语句SQL语法问题，支持各种复杂查询场景
  - 完善查询计划分析功能，优化性能分析体验 
  - 修复查询收藏功能，提升用户体验
  - 所有查询相关接口完成修复和验证
- 初始化Vue3项目结构
  - 使用Vue 3.2.47 + TypeScript 5.0
  - 使用Vite 4.3.9作为构建工具
- 配置Tailwind CSS 2.2.19
- 设置项目基础开发环境
- 创建基础组件结构
  - 导航栏组件 (TheNavigation.vue)
  - 页脚组件 (TheFooter.vue)
- 配置Vue Router路由系统
- 配置Pinia状态管理
- 集成Font Awesome 6.0.0图标库
- 添加TypeScript支持
- 设置ESLint和Prettier
- 创建项目目录结构
- 实现首页功能
  - 特性卡片组件 (FeatureCard.vue)
  - Hero区域组件 (HeroSection.vue)
  - 特性区域组件 (FeaturesSection.vue)
  - CTA区域组件 (CTASection.vue)
  - 首页视图组件 (HomeView.vue)
- 创建通用组件
  - 数据表格组件 (DataTable.vue)
  - 基础表单组件 (BaseForm.vue)
  - 消息提示组件 (MessageAlert.vue)
  - 加载动画组件 (LoadingSpinner.vue)
  - 确认对话框组件 (ConfirmModal.vue)
- 添加示例页面
  - 表格示例 (TableExample.vue)
  - 表单示例 (FormExample.vue)
  - 消息提示示例 (MessageExample.vue)
  - 加载动画示例 (LoadingExample.vue)
  - 确认对话框示例 (ModalExample.vue)
  - 示例首页 (ExamplesIndex.vue)
- 创建服务层
  - 消息服务 (message.ts)
  - 加载服务 (loading.ts)
  - 对话框服务 (modal.ts)
- 实现数据源管理模块
  - 数据源类型定义 (datasource.ts)
  - 元数据类型定义 (metadata.ts)
  - 数据源API服务 (services/datasource.ts)
  - 数据源状态管理 (stores/datasource.ts)
  - 数据源列表组件 (DataSourceList.vue)
  - 数据源表单组件 (DataSourceForm.vue)
  - 数据源详情组件 (DataSourceDetail.vue)
  - 数据源管理视图 (DataSourceView.vue)
  - 元数据浏览和管理功能
  - 连接测试模块
- 实现后端API联调
  - 添加环境变量配置，支持开发环境(.env.development)和生产环境配置
  - 优化数据源服务(datasource.ts)，实现与后端API的对接
  - 支持实际后端接口和模拟数据的无缝切换
  - 添加统一的响应处理逻辑，适配后端统一返回格式
  - 调整元数据API路径，使用 `/api/metadata/datasources` 代替原来的路径
  - 增加新的API支持，如获取同步历史、分析表列详情等
  - 添加数据结构适配层，处理前后端数据格式差异
  - 实现数据源对象的字段映射和类型转换
- 实现查询管理功能
  - 查询类型定义 (query.ts)
  - 元数据类型定义 (metadata.ts)
  - 查询API服务 (query.ts)
  - 查询状态管理 (stores/query.ts)
  - 查询组件模块
    - SQL编辑器组件 (SqlEditor.vue)
    - 查询历史组件 (QueryHistory.vue)
    - 查询结果组件 (QueryResults.vue)
    - 保存查询对话框组件 (SaveQueryModal.vue)
    - 元数据浏览器组件 (MetadataExplorer.vue)
    - 自然语言查询组件 (NaturalLanguageQuery.vue)
  - 查询管理视图模块优化
    - 核心查询编辑器页面 (QueryEditor.vue)
    - 独立查询历史页面 (QueryHistory.vue)
    - 查询分析页面 (QueryAnalytics.vue)
- 增强数据源管理功能
  - 元数据管理支持
  - 元数据加载与同步功能
  - 表结构和列信息浏览
- 数据源增强功能（第一阶段）
  - 表数据预览功能 (TableDataPreview.vue)
    - 分页浏览表数据
    - 表格数据排序
    - 表格列过滤
    - 数据导出为CSV
    - 列统计信息显示
    - 针对不同数据类型的过滤条件
  - 高级搜索功能
    - 跨数据源搜索 (AdvancedSearch.vue)
    - 搜索结果展示 (SearchResultsView.vue)
    - 搜索历史记录管理
    - 表、列、视图分类搜索
    - 正则表达式搜索支持
    - 精确匹配和模糊匹配选项
    - 搜索预设保存和加载
    - 搜索结果的分页显示
    - 详细的搜索统计信息
    - 搜索结果导出功能
- 查询可视化模块
  - 多种图表类型支持(柱状图、折线图、饼图、散点图、面积图、热力图、雷达图)
  - 图表配置界面与实时预览
  - 可自定义X轴、Y轴及分组选项
  - 保存与加载可视化配置
  - 图表导出功能
  - 查询结果与可视化切换视图
- 查询优化与分析功能
  - 查询执行计划展示
  - 性能优化建议
  - 查询改进建议
- 用户体验优化
  - 执行按钮错误提示功能增强
    - 查询编辑器页面(QueryEditor.vue)中，当执行条件不满足时(如未选择数据源或查询为空)，点击执行按钮会显示具体错误提示
    - 错误提示会指明具体问题和操作建议，如"请在左侧面板中选择一个数据源"或"请在SQL编辑器中输入查询语句"
    - 执行按钮添加了tooltip提示，鼠标悬停时会显示当前不可执行的原因

### Changed
- 更新数据源状态管理，增加元数据处理功能
- 完善数据源管理模块，增强用户体验
- 更新查询状态管理，提供完整的查询流程支持
- 增强类型定义，添加更多业务相关的类型支持
- 改进组件结构，提高代码复用性和可维护性
- 数据源管理与元数据管理功能组合，提供全面的数据管理能力
- 优化数据视图体验，添加数据预览和高级搜索功能
- 改进TableDataPreview组件，增加更多实用功能
  - 添加按列类型过滤的智能过滤面板
  - 增加列统计信息显示
  - 优化排序和过滤交互体验
- 统一用户界面操作体验
  - 将数据源列表页面的操作按钮改为图标形式，与查询列表页面保持一致
  - 精简数据源列表的操作按钮，主界面只保留查看、编辑和删除三个常用操作
  - 将测试连接和同步元数据等不常用操作移至下拉菜单中，减少视觉干扰
  - 优化图标和按钮的视觉效果，增强用户体验
- 升级AdvancedSearch组件，支持更复杂的搜索需求
  - 添加搜索预设保存和加载功能
  - 支持正则表达式和高级匹配选项
  - 改进搜索历史记录管理
- 增强SearchResultsView组件，提供更详细的搜索结果展示和操作功能
  - 添加分页功能，提高大数据集的浏览体验
  - 增加详细的搜索统计指标展示
  - 提供CSV格式的搜索结果导出
- 数据源状态管理重构
  - 使用Pinia替代Vuex
  - 改进错误处理机制
  - 优化状态更新逻辑
- 查询状态管理重构
  - 使用Composition API重写
  - 分离查询执行与状态管理逻辑
  - 添加查询结果缓存策略
- 优化集成预览界面
  - 移除了低代码预览和标准预览的切换选项卡
  - 统一预览模式，简化用户体验
  - 保留所有核心功能，包括表格预览和图表预览

### Fixed
- 修复PostCSS配置文件导致的启动问题
- 修复路由导航错误
- 修复组件导入路径问题
- 修复BaseForm.vue中模板字符串中反斜线转义错误问题
- 修复DataSourceList.vue组件中未正确处理props.dataSources为空的情况导致的错误
- 修复DataSourceView.vue中未传递必要的props到DataSourceList组件的问题
- 修复DataSourceList组件的事件处理，补充了add事件和select事件的支持
- 解决TableDataPreview在不同数据类型下过滤条件不正确的问题
- 优化SearchResultsView组件在大量数据情况下的性能问题
- 修复AdvancedSearch组件中正则表达式验证逻辑
- 解决数据导出时特殊字符处理的问题
- 解决搜索结果统计指标计算不准确的问题
- 修复集成创建功能中出现重复数据的问题
  - 修改mockData.ts中的createMockIntegration方法，添加重复检测逻辑
  - 优化saveMockIntegrationsToStorage函数，增加对重复集成的过滤
  - 添加调试日志，方便排查问题
  - 防止在用户点击保存按钮时重复创建相同的集成
- 修复路由导航问题
  - 解决查询详情页刷新后数据丢失问题
  - 修复历史记录导航错误
- 修复组件导入问题
  - 更正异步组件加载错误
  - 优化组件加载性能
- 修复配置问题
  - 解决开发环境与生产环境配置差异
  - 修正API路径配置
- 修复QueryHistory.vue组件中的函数调用错误
  - 修复从useQueryStore的导入方式（从默认导入改为命名导入）
  - 将loadQueryHistory方法调用修改为正确的fetchQueryHistory方法
  - 将loadFavorites方法调用修改为getFavorites方法
  - 修复TypeScript类型转换问题
- 解决查询模块重构中的类型错误
  - 修复在查询编辑器中加载查询时的类型转换问题
  - 处理EventTarget类型的安全转换
  - 修正DOM操作中的类型断言
  - 统一和标准化事件处理函数
- 修复元数据浏览器中的搜索结果显示问题
  - 解决无搜索结果时重复显示提示的问题
  - 优化搜索功能的用户体验
- 修复查询详情页面（QueryDetail.vue）和查询分析页面（QueryAnalytics.vue）中的getQueryById调用错误
  - 将不存在的getQueryById方法替换为正确的currentQuery状态
  - 将不存在的results属性替换为正确的currentQueryResult状态
  - 确保数据正确加载，解决详情页无法访问的问题
- 改进页面标题显示
  - 优化查询详情页和查询分析页的标题，显示具体的查询名称，保持与其他详情页面的一致性
  - 将页面内的"查询详情"标题改为更具描述性的"基本信息"标题，避免与页面主标题重复
- 增强查询详情和分析页面的错误处理
- 修复图表预览页面数据显示undefined的问题
  - 增强ChartPreview组件处理undefined数据的能力
  - 添加字段检查逻辑，验证数据映射字段存在于返回数据中
  - 增加防御性编程，确保即使数据字段不匹配也能优雅降级
  - 改进错误信息反馈，帮助用户定位配置问题
  - 增强调试日志输出，方便开发人员排查字段映射问题
- 修复数据源API调用与后端接口不匹配的问题
  - 修正数据源类型(type)在API请求中的格式，确保发送小写，接收时转为大写
  - 修复连接选项字段名不匹配问题，前端使用connectionOptions而后端使用connectionParams
  - 增强数据适配层，正确处理后端返回的各种数据结构
  - 修复分页逻辑，处理后端返回数组而非标准分页对象的情况
  - 优化测试连接和同步元数据API请求和响应处理
  - 完善错误处理和默认值逻辑，提高代码健壮性

## 2023年7月15日

### UI优化
- 统一了查询相关页面的容器样式，使用 `container mx-auto px-4 py-6` 类
- 增强了不同页面间的视觉一致性
- 改进了各页面在不同尺寸设备上的响应式布局
- 移除了左面板中重复的搜索框，保留`MetadataExplorer`组件中的搜索功能
- 移除了`MetadataExplorer`组件顶部的不必要工具栏，简化界面并将搜索框作为顶部元素
- 优化了查询详情页和查询分析页的页面布局
  - 移除了顶部导航栏，将标题和返回按钮移至内容区域
  - 将编辑查询按钮放置在基本信息卡片的标题栏旁边，与收藏、分享等操作按钮保持一致
  - 改进了标题显示，使其与其他详情页面保持一致的风格
- 重构了查询历史页面的UI布局
  - 从左右结构改为上下结构，与原型设计保持一致
  - 将筛选条件放在顶部，查询列表放在下方
  - 添加了预设日期范围选择器，支持快速筛选最近24小时、7天和30天的记录
  - 实现分页导航，替代原有的"加载更多"按钮
  - 添加了导出历史数据功能，支持将查询历史导出为CSV格式
  - 移除了"应用筛选"按钮，改为表单变化时自动触发查询，简化用户操作
  - 保留了"清除筛选"按钮并优化其位置和样式，方便用户快速重置筛选条件
  - 为搜索框添加防抖功能，提高搜索体验，避免频繁触发查询
- 统一了所有列表页面的分页样式
  - 优化并统一了数据源列表、查询列表和查询历史页面的分页组件
  - 采用带页码的分页样式替代简单的上一页/下一页导航
  - 实现了智能页码显示，当页数较多时会显示省略号
  - 使分页组件底部显示当前显示的记录范围和总数信息
  - 确保分页组件在不同尺寸的屏幕上保持良好的显示效果和操作体验

### 功能增强
- 新增独立的查询详情页面，提供更全面的查询信息展示
- 查询详情页整合了基本信息、可视化、执行计划、优化建议和结果展示等多个功能模块
- 查询历史列表新增"查看详情"按钮，方便用户快速查阅完整的查询细节
- 查询列表页新增"查看详情"按钮，允许从主列表直接跳转到查询详情页面
- 优化了查询结果的导出功能，支持CSV、Excel和JSON多种格式
- 在查询详情页添加执行历史功能区域
  - 显示查询的历史执行记录，包括执行时间、耗时、状态和结果
  - 提供"查看结果"和"查看错误"按钮，快速定位到特定执行的结果或错误信息
  - 对成功执行的查询显示结果行数，对失败的查询显示错误信息摘要

### Bug修复
- 修复查询详情页面（QueryDetail.vue）和查询分析页面（QueryAnalytics.vue）中的getQueryById调用错误
  - 将不存在的getQueryById方法替换为正确的currentQuery状态
  - 将不存在的results属性替换为正确的currentQueryResult状态
  - 确保数据正确加载，解决详情页无法访问的问题
- 改进页面标题显示
  - 优化查询详情页和查询分析页的标题，显示具体的查询名称，保持与其他详情页面的一致性
  - 将页面内的"查询详情"标题改为更具描述性的"基本信息"标题，避免与页面主标题重复
- 增强查询详情和分析页面的错误处理
  - 改进查询不存在时的错误提示，提供更明确的错误信息
  - 添加对无效查询ID的检测和处理逻辑，避免页面显示空白

## 未发布的更改

### 修复
- 修复syncMetadata方法异常捕获逻辑，确保在网络错误时返回失败结果而非抛出异常
- 修复数据源表单(DataSourceForm.vue)中的初始化顺序问题，解决了"Cannot access 'validateForm' before initialization"错误
  - 重新组织了代码，确保formData和其他相关变量在validateForm函数定义之前声明
  - 确保表单在编辑模式下能正确初始化并验证
- 更新表数据预览API调用，适配后端新的接口格式
  - 修正API路径，由`/api/metadata/${dataSourceId}/tables/${tableName}`改为`/api/metadata/${dataSourceId}/tables/${tableName}/data`
  - 增强响应处理逻辑，兼容多种不同的API响应结构
  - 添加降级处理，在遇到未知响应格式时提供合理的默认行为
  - 解决无数据显示的问题，确保"无数据可显示"提示仅在真正无数据时出现
  - 修复MySQL DESC格式列定义的处理，正确解析Field和Type字段
  - 强化类型安全处理，避免因列格式差异导致的错误
- 修复导航栏中首页链接无法正常跳转的问题
  - 将根路由从重定向改为直接加载HomeView组件
  - 确保导航栏中的首页链接能正确映射到首页
  - 提升页面导航的稳定性和可靠性
- 优化数据源表单体验
  - 修复表单验证时机，改为仅在提交时验证而非页面加载时就显示必填错误
  - 为所有输入框和文本域添加了合适的占位文本提示
  - 增强表单交互友好性，提高用户填写体验
- 修复数据源详情页表元数据获取问题
  - 解决了表名获取错误导致API请求URL中出现`[object Object]`的问题
  - 修正了API请求地址，移除了硬编码的服务器地址，改用相对路径`/api/metadata/`
  - 添加了`getTableDisplayName`安全函数，统一处理各种表对象格式
  - 优化了表对象结构规范化过程，确保表对象始终具有有效的表名
  - 改进表格UI渲染，现在能够正确解析和显示复杂的表结构
  - 修复了表展开和数据预览功能的表名处理逻辑
  - 添加健壮性检查，确保在表结构不规范情况下也能正常处理
  - 完善错误处理，提供更详细的调试日志
  - 修复了JSON序列化错误，确保日志输出时不会出现循环引用问题
- 修复了数据源服务中的default导出问题，确保服务正常启动
- 为防止类似问题，创建了数据源服务恢复脚本和备份机制

### 更改
- 简化数据源列表页面布局
  - 移除了数据源列表底部的"添加数据源"按钮，减少重复操作入口
  - 隐藏了页面顶部的"高级搜索"按钮，简化了用户界面
  - 保持了页面顶部的"添加数据源"按钮作为唯一的添加入口
- 数据源管理功能优化
  - 禁用了数据库类型选择下拉框，并默认设置为MySQL
  - 在表单中添加说明，表明当前版本仅支持MySQL数据源
  - 确保所有新建和编辑操作中数据库类型始终为MySQL
