# DataScope - 系统架构

## 概述

DataScope是一个全面的数据管理和查询系统，允许用户集成不同的数据库系统，探索元数据，执行查询，并创建低代码集成。本文档描述了系统的整体架构设计，包括核心组件、模块结构和关键技术选择。

## 架构原则

DataScope的架构设计遵循以下原则：

1. **领域驱动设计(DDD)** - 使用DDD方法组织代码，将业务逻辑与技术实现分离
2. **关注点分离** - 清晰地分离不同的系统职责
3. **模块化** - 通过定义明确的模块边界实现高内聚低耦合
4. **可扩展性** - 设计灵活的架构以支持新的数据源类型和功能
5. **安全优先** - 在设计的各个层面考虑安全性
6. **可测试性** - 架构支持各个层次的自动化测试

## 系统架构概览

DataScope采用前后端分离的模块化架构，后端基于领域驱动设计原则组织。

### 高级架构图

```
+------------------+    +------------------+    +------------------+
|                  |    |                  |    |                  |
|   前端应用       |<-->|   后端API        |<-->|   数据源         |
|                  |    |                  |    |                  |
+------------------+    +------------------+    +------------------+
                              |
                              v
                        +------------------+
                        |                  |
                        |   系统数据库     |
                        |                  |
                        +------------------+
```

### 后端架构

后端采用分层架构，遵循领域驱动设计原则：

```
+----------------------------------------------------------+
|                      表现层 (Facade)                      |
|                                                          |
|  +------------------+  +------------------+              |
|  |     REST API     |  |    DTO对象       |              |
|  +------------------+  +------------------+              |
+----------------------------------------------------------+
                            |
+----------------------------------------------------------+
|                      应用层 (Application)                 |
|                                                          |
|  +------------------+  +------------------+              |
|  |    应用服务      |  |    事务管理      |              |
|  +------------------+  +------------------+              |
+----------------------------------------------------------+
                            |
+----------------------------------------------------------+
|                      领域层 (Domain)                      |
|                                                          |
|  +------------------+  +------------------+              |
|  |    领域实体      |  |    领域服务      |              |
|  +------------------+  +------------------+              |
|                                                          |
|  +------------------+  +------------------+              |
|  |    值对象        |  |    仓储接口      |              |
|  +------------------+  +------------------+              |
+----------------------------------------------------------+
                            |
+----------------------------------------------------------+
|                    基础设施层 (Infrastructure)            |
|                                                          |
|  +------------------+  +------------------+              |
|  |    仓储实现      |  |    外部服务集成  |              |
|  +------------------+  +------------------+              |
|                                                          |
|  +------------------+  +------------------+              |
|  |    ORM映射       |  |    缓存实现      |              |
|  +------------------+  +------------------+              |
+----------------------------------------------------------+
```

## 核心组件

### 数据源管理

数据源管理组件负责管理与外部数据库系统的连接。

#### 主要功能

- 数据源连接配置管理
- 连接凭据的安全存储
- 连接池管理
- 连接健康监控

#### 关键类

- `DataSource` - 数据源实体
- `DataSourceRepository` - 数据源仓储接口
- `DataSourceService` - 数据源领域服务
- `ConnectionManager` - 连接管理器
- `CredentialEncryptor` - 凭据加密工具

#### 数据流

1. 用户通过UI配置数据源连接信息
2. 系统加密敏感凭据并存储数据源信息
3. 连接管理器维护连接池并处理连接请求
4. 健康监控组件定期检查连接状态

### 元数据管理

元数据管理组件负责从数据源提取和管理元数据（模式、表、列等）。

#### 主要功能

- 元数据提取
- 元数据同步（全量和增量）
- 元数据缓存
- 元数据搜索和浏览

#### 关键类

- `MetadataExtractor` - 元数据提取器
- `MetadataRepository` - 元数据仓储接口
- `MetadataSynchronizer` - 元数据同步器
- `MetadataCache` - 元数据缓存
- `Schema`, `Table`, `Column` - 元数据实体

#### 数据流

1. 元数据同步器触发元数据提取
2. 元数据提取器从数据源获取元数据
3. 系统比较新旧元数据并应用更改
4. 更新后的元数据存储在系统数据库中
5. 元数据缓存更新以提供快速访问

### 查询执行

查询执行组件负责执行SQL查询并处理结果。

#### 主要功能

- SQL查询验证
- 查询参数处理
- 查询执行和结果处理
- 查询超时管理
- 查询历史记录

#### 关键类

- `QueryExecutor` - 查询执行器
- `QueryValidator` - 查询验证器
- `QueryRepository` - 查询仓储接口
- `QueryResult` - 查询结果
- `QueryHistory` - 查询历史记录

#### 数据流

1. 用户提交SQL查询和参数
2. 查询验证器验证查询语法和安全性
3. 查询执行器连接到目标数据源并执行查询
4. 系统处理结果并返回给用户
5. 查询历史记录更新

### 自然语言处理

自然语言处理组件负责将自然语言转换为SQL查询。

#### 主要功能

- 自然语言理解
- SQL生成
- 上下文感知查询
- 学习和改进

#### 关键类

- `NaturalLanguageProcessor` - 自然语言处理器
- `LLMIntegration` - LLM集成
- `SQLGenerator` - SQL生成器
- `ContextManager` - 上下文管理器

#### 数据流

1. 用户提交自然语言查询
2. 系统将查询与元数据上下文一起发送到LLM
3. LLM生成SQL查询
4. 系统验证生成的SQL并执行
5. 用户反馈用于改进

### 关系管理

关系管理组件负责管理表之间的关系。

#### 主要功能

- 手动关系定义
- 自动关系推断
- 关系可视化
- 关系使用跟踪

#### 关键类

- `Relationship` - 关系实体
- `RelationshipRepository` - 关系仓储接口
- `RelationshipInferenceEngine` - 关系推断引擎
- `RelationshipService` - 关系服务

#### 数据流

1. 系统分析元数据和查询模式
2. 关系推断引擎识别潜在关系
3. 用户确认或拒绝推断的关系
4. 关系存储并用于改进查询生成

### 低代码集成

低代码集成组件负责生成API和UI配置。

#### 主要功能

- API生成
- UI配置管理
- 参数映射
- 结果格式化
- 版本控制

#### 关键类

- `APIGenerator` - API生成器
- `UIConfigurationManager` - UI配置管理器
- `ParameterMapper` - 参数映射器
- `ResultFormatter` - 结果格式化器
- `LowCodeConfig` - 低代码配置实体

#### 数据流

1. 用户选择查询并配置API参数
2. 系统生成API端点和文档
3. 用户配置UI表单和结果显示
4. 系统生成低代码集成配置
5. 低代码平台通过API和配置集成

## 技术栈

### 后端

- **编程语言**: Java 17
- **应用框架**: Spring Boot 3.x
- **ORM框架**: MyBatis
- **数据库**: MySQL 8.0+（系统数据库）
- **缓存**: Redis
- **安全**: Spring Security, AES加密
- **API文档**: Swagger/OpenAPI
- **构建工具**: Maven

### 数据源支持

- MySQL 5.7+/8.0+
- DB2 11.5+

### 外部集成

- **LLM服务**: OpenRouter API
- **低代码平台**: 通过JSON协议集成

## 数据流

### 主要数据流

1. **元数据同步流程**:
   ```
   数据源 -> 元数据提取器 -> 元数据同步器 -> 系统数据库 -> 元数据缓存
   ```

2. **SQL查询流程**:
   ```
   用户 -> API -> 查询验证器 -> 查询执行器 -> 数据源 -> 查询结果 -> 用户
   ```

3. **自然语言查询流程**:
   ```
   用户 -> API -> 自然语言处理器 -> LLM服务 -> SQL生成器 -> 查询执行器 -> 数据源 -> 查询结果 -> 用户
   ```

4. **低代码集成流程**:
   ```
   查询 -> API生成器 -> API端点 -> UI配置管理器 -> 低代码配置 -> 低代码平台
   ```

## 安全架构

### 认证和授权

- 集成外部认证系统
- 基于角色的访问控制
- API密钥管理
- 会话管理

### 数据保护

- 数据源凭据加密存储
- 敏感数据屏蔽
- 传输中数据加密(HTTPS)
- 审计日志记录

### API安全

- 输入验证
- 速率限制
- CSRF保护
- 错误处理

## 可扩展性

### 数据源扩展

系统设计支持添加新的数据源类型：

1. 实现`DataSourceConnector`接口
2. 实现`MetadataExtractor`接口
3. 注册新的数据源类型

### 功能扩展

- 模块化设计允许添加新功能
- 插件架构支持第三方扩展
- 事件驱动设计支持松耦合集成

## 性能考虑

### 缓存策略

- 元数据缓存
- 查询结果缓存
- 配置缓存

### 查询优化

- 查询超时管理
- 连接池优化
- 资源限制

### 并发处理

- 异步处理长时间运行的操作
- 线程池管理
- 乐观锁定

## 部署架构

### 单节点部署

```
+----------------------------------------------------------+
|                                                          |
|                      应用服务器                           |
|                                                          |
|  +------------------+  +------------------+              |
|  |   DataScope应用   |  |   Redis缓存      |              |
|  +------------------+  +------------------+              |
|                                                          |
+----------------------------------------------------------+
                            |
+----------------------------------------------------------+
|                                                          |
|                      数据库服务器                         |
|                                                          |
|  +------------------+                                    |
|  |   MySQL数据库     |                                    |
|  +------------------+                                    |
|                                                          |
+----------------------------------------------------------+
```

### 高可用部署

```
+------------------+    +------------------+
|                  |    |                  |
|   负载均衡器      |<-->|   应用服务器1    |
|                  |    |                  |
+------------------+    +------------------+
        |
        |               +------------------+
        |               |                  |
        +-------------->|   应用服务器2    |
                        |                  |
                        +------------------+
                              |
                              v
+------------------+    +------------------+
|                  |    |                  |
|   Redis集群      |<-->|   MySQL主从      |
|                  |    |                  |
+------------------+    +------------------+
```

## 监控和运维

### 监控

- 应用健康检查
- 性能指标收集
- 日志聚合
- 警报配置

### 运维

- 数据库备份和恢复
- 配置管理
- 版本升级流程
- 故障恢复计划

## 结论

DataScope的架构设计遵循领域驱动设计原则，提供了一个模块化、可扩展和安全的系统，用于管理和查询多个数据源。该架构支持核心功能，包括数据源管理、元数据同步、查询执行、自然语言处理和低代码集成。

通过清晰的关注点分离和定义良好的接口，系统可以灵活地适应新的需求和技术变化。安全性和性能考虑已经融入设计的各个方面，确保系统能够安全高效地运行。