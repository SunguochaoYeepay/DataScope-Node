# DataScope Node å‰åç«¯å¯¹æ¥è§„èŒƒ

## å‰è¨€

ä¸ºç¡®ä¿å‰åç«¯å¼€å‘é«˜æ•ˆåä½œï¼Œæœ¬æ–‡æ¡£å®šä¹‰äº†å‰åç«¯APIå¯¹æ¥è§„èŒƒï¼Œç‰¹åˆ«å…³æ³¨åç«¯æ¥å£ä¸å‰ç«¯Mockå®ç°çš„ä¸€è‡´æ€§ä¿éšœæœºåˆ¶ã€‚

## ä¸€ã€Mockæ•°æ®åˆ†æä¸APIå¯¹é½ç­–ç•¥

### 1. Mockæ•°æ®ç»“æ„æå–ä¸åˆ†æ
- ä»å‰ç«¯Mockæ–‡ä»¶æå–æ¥å£å®šä¹‰ã€å‚æ•°ç»“æ„å’Œå“åº”æ¨¡å¼
- åˆ†ææ‰€æœ‰Mock APIè°ƒç”¨ä¸­çš„è¯·æ±‚å‚æ•°ç±»å‹å’Œå“åº”ç±»å‹
- ä¸ºæ¯ä¸ªMockæ¥å£åˆ›å»ºå¯¹åº”çš„OpenAPIè§„èŒƒæ–‡æ¡£

### 2. ç±»å‹å®šä¹‰å¯¹é½
- ä»å‰ç«¯`types`ç›®å½•æå–æ‰€æœ‰ç±»å‹å®šä¹‰
- ç¡®ä¿åç«¯ä½¿ç”¨å®Œå…¨ä¸€è‡´çš„ç±»å‹å®šä¹‰
- å»ºç«‹ç±»å‹æ˜ å°„è¡¨ï¼Œç¡®ä¿å‰åç«¯æ•°æ®ç±»å‹ä¸€è‡´æ€§

### 3. APIç­¾åå¯¹é½
åç«¯å®ç°å¿…é¡»ä¸¥æ ¼éµå¾ªå‰ç«¯Mockä¸­çš„APIç­¾åï¼š
  - URLè·¯å¾„ä¿æŒä¸€è‡´
  - è¯·æ±‚æ–¹æ³•ä¿æŒä¸€è‡´
  - æŸ¥è¯¢å‚æ•°ä¿æŒä¸€è‡´
  - è¯·æ±‚ä½“ç»“æ„ä¿æŒä¸€è‡´
  - å“åº”ç»“æ„ä¿æŒä¸€è‡´

## äºŒã€å¯¹æ¥å·¥å…·ä¸æµç¨‹

### 1. è‡ªåŠ¨åŒ–å¯¹æ¯”å·¥å…·

å¼€å‘å·¥å…·ç”¨äºæ¯”è¾ƒå‰ç«¯Mockä¸åç«¯å®ç°çš„ä¸€è‡´æ€§ï¼š

```typescript
// mockValidationTool.ts
import { mockDataSourceApi } from '../webview-ui/src/mocks/datasource';
import { mockQueryApi } from '../webview-ui/src/mocks/query';
import * as fs from 'fs';
import * as path from 'path';
import * as swaggerParser from '@apidevtools/swagger-parser';

// æå–Mock APIç­¾å
function extractMockApis() {
  const mockApis = [];
  
  // æå–æ•°æ®æºAPI
  for (const key in mockDataSourceApi) {
    if (typeof mockDataSourceApi[key] === 'function') {
      const funcStr = mockDataSourceApi[key].toString();
      mockApis.push({
        name: key,
        group: 'datasource',
        parameters: extractParameters(funcStr),
        returnType: extractReturnType(funcStr)
      });
    }
  }
  
  // æå–æŸ¥è¯¢API
  for (const key in mockQueryApi) {
    if (typeof mockQueryApi[key] === 'function') {
      const funcStr = mockQueryApi[key].toString();
      mockApis.push({
        name: key,
        group: 'query',
        parameters: extractParameters(funcStr),
        returnType: extractReturnType(funcStr)
      });
    }
  }
  
  return mockApis;
}

// ä¸OpenAPIè§„èŒƒå¯¹æ¯”
async function compareWithOpenAPI(mockApis, openapiPath) {
  const openapi = await swaggerParser.parse(openapiPath);
  const results = [];
  
  for (const mockApi of mockApis) {
    // åœ¨OpenAPIä¸­æŸ¥æ‰¾å¯¹åº”çš„API
    const matchingPath = findMatchingPath(openapi, mockApi);
    
    if (matchingPath) {
      // æ£€æŸ¥å‚æ•°å’Œå“åº”æ˜¯å¦åŒ¹é…
      const parametersMatch = compareParameters(mockApi.parameters, matchingPath.parameters);
      const responseMatch = compareResponses(mockApi.returnType, matchingPath.responses);
      
      results.push({
        name: mockApi.name,
        matches: parametersMatch && responseMatch,
        details: {
          parametersMatch,
          responseMatch
        }
      });
    } else {
      results.push({
        name: mockApi.name,
        matches: false,
        details: {
          error: 'API not found in OpenAPI spec'
        }
      });
    }
  }
  
  return results;
}

// ä¸»å‡½æ•°
async function validateMockApiConsistency() {
  const mockApis = extractMockApis();
  const openapiPath = path.join(__dirname, '../webService/src/api/swagger.json');
  
  if (fs.existsSync(openapiPath)) {
    const results = await compareWithOpenAPI(mockApis, openapiPath);
    
    // ç”ŸæˆæŠ¥å‘Š
    const matchCount = results.filter(r => r.matches).length;
    console.log(`APIåŒ¹é…åº¦: ${matchCount}/${results.length} (${(matchCount/results.length*100).toFixed(2)}%)`);
    
    // è¯¦ç»†æŠ¥å‘Š
    for (const result of results) {
      if (!result.matches) {
        console.log(`APIä¸åŒ¹é…: ${result.name}`);
        console.log(result.details);
      }
    }
  } else {
    // ç”ŸæˆOpenAPIæ¨¡æ¿
    const template = generateOpenAPITemplate(mockApis);
    fs.writeFileSync(openapiPath, JSON.stringify(template, null, 2));
    console.log(`å·²ç”ŸæˆOpenAPIæ¨¡æ¿: ${openapiPath}`);
  }
}
```

### 2. è‡ªåŠ¨ä»£ç ç”Ÿæˆç­–ç•¥

ä»å‰ç«¯Mockæ•°æ®è‡ªåŠ¨ç”Ÿæˆåç«¯ä»£ç éª¨æ¶ï¼š

```typescript
// é€šè¿‡è§£æMockæ•°æ®è‡ªåŠ¨ç”ŸæˆController
function generateController(mockApi, group) {
  const camelToKebab = str => str.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
  
  const template = `
import { Request, Response, NextFunction } from 'express';
import { ${group}Service } from '../../services/${group}Service';

/**
 * @swagger
 * ${generateSwaggerDocs(mockApi, group)}
 */
export async function ${mockApi.name}(req: Request, res: Response, next: NextFunction) {
  try {
    // Extract parameters
    ${extractParametersCode(mockApi)}
    
    // Call service
    const result = await ${group}Service.${mockApi.name}(${getParamNames(mockApi)});
    
    // Return response
    return res.json({
      code: 0,
      message: 'Success',
      data: result,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    next(error);
  }
}
  `;
  
  return template;
}
```

### 3. æµ‹è¯•ç”Ÿæˆå·¥å…·

ä¸ºæ¯ä¸ªAPIç«¯ç‚¹è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ï¼Œç¡®ä¿ä¸Mockè¡Œä¸ºä¸€è‡´ï¼š

```typescript
// ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
function generateTestsFromMock(mockApi, group) {
  const template = `
import { expect } from 'chai';
import sinon from 'sinon';
import { ${mockApi.name} } from '../../src/api/controllers/${group}Controller';
import { ${group}Service } from '../../src/services/${group}Service';

describe('${group}Controller - ${mockApi.name}', () => {
  let req, res, next, serviceStub;
  
  beforeEach(() => {
    req = {
      params: {},
      query: {},
      body: {}
    };
    res = {
      json: sinon.spy()
    };
    next = sinon.spy();
    
    // StubæœåŠ¡å±‚è¿”å›Mockæ•°æ®
    serviceStub = sinon.stub(${group}Service, '${mockApi.name}');
    serviceStub.resolves(${generateMockResponseData(mockApi)});
  });
  
  afterEach(() => {
    serviceStub.restore();
  });
  
  it('should return data matching mock structure', async () => {
    // Setup request parameters
    ${setupRequestParameters(mockApi)}
    
    // Call controller
    await ${mockApi.name}(req, res, next);
    
    // Verify response
    expect(res.json.calledOnce).to.be.true;
    const response = res.json.firstCall.args[0];
    expect(response.code).to.equal(0);
    expect(response.data).to.deep.equal(${generateMockResponseData(mockApi)});
  });
});
  `;
  
  return template;
}
```

## ä¸‰ã€APIæ–‡æ¡£ç”Ÿæˆä¸ç»´æŠ¤

### 1. OpenAPI/Swaggeræ–‡æ¡£é›†æˆ
- ä½¿ç”¨swagger-jsdocæ·»åŠ APIæ³¨é‡Š
- é›†æˆswagger-ui-expressæä¾›å¯è§†åŒ–APIæ–‡æ¡£ç•Œé¢
- åœ¨å¼€å‘ç¯å¢ƒä¸­é»˜è®¤å¯ç”¨APIæ–‡æ¡£è®¿é—®
- ç”Ÿäº§ç¯å¢ƒå¯é€šè¿‡é…ç½®æ§åˆ¶æ–‡æ¡£è®¿é—®æƒé™

### 2. APIæ–‡æ¡£æ³¨é‡Šè§„èŒƒ
- å»ºç«‹ç»Ÿä¸€çš„APIæ³¨é‡Šæ¨¡æ¿
- ä¸ºæ¯ä¸ªAPIç«¯ç‚¹æ·»åŠ è¯¦ç»†çš„JSDocæ³¨é‡Š
- åŒ…å«è¯·æ±‚å‚æ•°ã€å“åº”æ ¼å¼ã€é”™è¯¯ç è¯´æ˜
- æ·»åŠ ç¤ºä¾‹è¯·æ±‚å’Œå“åº”

### 3. Swaggerè®¾ç½®ç¤ºä¾‹
```typescript
// swagger.ts
import swaggerJsDoc from 'swagger-jsdoc';
import swaggerUi from 'swagger-ui-express';

const swaggerOptions = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'DataScope API',
      version: '1.0.0',
      description: 'DataScope Node APIæ–‡æ¡£',
      contact: {
        name: 'DataScope Team'
      }
    },
    servers: [
      {
        url: '/api/v1',
        description: 'APIæœåŠ¡ç«¯ç‚¹'
      }
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT'
        }
      }
    },
    security: [
      {
        bearerAuth: []
      }
    ]
  },
  apis: ['./src/api/routes/*.ts', './src/api/controllers/*.ts']
};

export const swaggerSpec = swaggerJsDoc(swaggerOptions);

export const setupSwagger = (app: any) => {
  // APIæ–‡æ¡£è·¯ç”±
  app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerSpec));
  
  // APIè§„èŒƒJSONç«¯ç‚¹
  app.get('/api-spec.json', (req: any, res: any) => {
    res.setHeader('Content-Type', 'application/json');
    res.send(swaggerSpec);
  });
  
  console.log('ğŸ”„ APIæ–‡æ¡£å·²è®¾ç½®ï¼Œè®¿é—®è·¯å¾„: /api-docs');
};
```

### 4. APIæ³¨é‡Šç¤ºä¾‹
```typescript
/**
 * @swagger
 * /datasources:
 *   get:
 *     summary: è·å–æ•°æ®æºåˆ—è¡¨
 *     description: æ ¹æ®æŸ¥è¯¢æ¡ä»¶è·å–æ•°æ®æºåˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µ
 *     tags: [DataSources]
 *     parameters:
 *       - in: query
 *         name: page
 *         schema:
 *           type: integer
 *           default: 1
 *         description: é¡µç 
 *       - in: query
 *         name: size
 *         schema:
 *           type: integer
 *           default: 10
 *         description: æ¯é¡µå¤§å°
 *       - in: query
 *         name: status
 *         schema:
 *           type: string
 *           enum: [ACTIVE, INACTIVE]
 *         description: æ•°æ®æºçŠ¶æ€è¿‡æ»¤
 *       - in: query
 *         name: type
 *         schema:
 *           type: string
 *           enum: [MYSQL, DB2]
 *         description: æ•°æ®æºç±»å‹è¿‡æ»¤
 *     responses:
 *       200:
 *         description: æˆåŠŸè·å–æ•°æ®æºåˆ—è¡¨
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 code:
 *                   type: integer
 *                   example: 0
 *                 message:
 *                   type: string
 *                   example: æˆåŠŸè·å–æ•°æ®æºåˆ—è¡¨
 *                 data:
 *                   type: object
 *                   properties:
 *                     items:
 *                       type: array
 *                       items:
 *                         $ref: '#/components/schemas/DataSource'
 *                     total:
 *                       type: integer
 *                       example: 25
 *                     page:
 *                       type: integer
 *                       example: 1
 *                     size:
 *                       type: integer
 *                       example: 10
 *                 timestamp:
 *                   type: string
 *                   format: date-time
 */
export async function getDataSources(req: Request, res: Response, next: NextFunction) {
  // å®ç°é€»è¾‘
}
```

## å››ã€é›†æˆåˆ°å¼€å‘æµç¨‹

### 1. æ„å»ºé˜¶æ®µæ£€æŸ¥

åœ¨CIæµç¨‹ä¸­æ·»åŠ æ£€æŸ¥æ­¥éª¤ï¼Œç¡®ä¿åç«¯å®ç°ä¸å‰ç«¯Mockæ•°æ®ä¿æŒä¸€è‡´ï¼š

```bash
# åœ¨CIè„šæœ¬ä¸­æ·»åŠ 
npm run validate-api-consistency

# å¦‚æœéªŒè¯ä¸é€šè¿‡ï¼Œæ„å»ºå¤±è´¥
if [ $? -ne 0 ]; then
  echo "APIä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥ï¼Œåç«¯å®ç°ä¸å‰ç«¯Mockä¸åŒ¹é…"
  exit 1
fi
```

### 2. å¼€å‘å·¥ä½œæµé›†æˆ

å°†æ¥å£ä¸€è‡´æ€§æ£€æŸ¥æ•´åˆåˆ°æ—¥å¸¸å¼€å‘æµç¨‹ï¼š

1. å‰ç«¯å¼€å‘å®ŒæˆMockå®ç°åï¼Œè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£ä½œä¸ºå¥‘çº¦
2. åç«¯å¼€å‘æ—¶ï¼Œä½¿ç”¨å·¥å…·ç”ŸæˆåŸºäºMockçš„éª¨æ¶ä»£ç 
3. å®ç°è¿‡ç¨‹ä¸­ï¼Œå®šæœŸè¿è¡Œä¸€è‡´æ€§æ£€æŸ¥
4. æäº¤å‰å¼ºåˆ¶éªŒè¯APIä¸€è‡´æ€§

### 3. æ‰‹åŠ¨æ£€æŸ¥æ¸…å•

é™¤äº†è‡ªåŠ¨åŒ–å·¥å…·ï¼Œè¿˜éœ€è¦æ‰‹åŠ¨æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

- **è·¯å¾„åŒ¹é…**ï¼šç¡®ä¿APIè·¯å¾„å®Œå…¨ä¸€è‡´
- **å‚æ•°åŒ¹é…**ï¼šç¡®ä¿å‚æ•°åç§°ã€ç±»å‹å’Œå¯é€‰æ€§ä¸€è‡´
- **å“åº”ç»“æ„**ï¼šç¡®ä¿å“åº”æ•°æ®ç»“æ„ä¸€è‡´
- **é”™è¯¯å¤„ç†**ï¼šç¡®ä¿é”™è¯¯ç å’Œé”™è¯¯æ¶ˆæ¯ä¸€è‡´
- **åˆ†é¡µé€»è¾‘**ï¼šç¡®ä¿åˆ†é¡µå‚æ•°å’Œè¿”å›æ ¼å¼ä¸€è‡´
- **å­—æ®µå‘½å**ï¼šç¡®ä¿å­—æ®µå‘½åé£æ ¼ä¸€è‡´ï¼ˆé©¼å³°å¼ï¼‰

## äº”ã€æ–‡æ¡£åŒæ­¥æœºåˆ¶

### 1. åŒå‘æ–‡æ¡£æ›´æ–°

å®ç°å‰ç«¯Mockå’Œåç«¯APIæ–‡æ¡£çš„åŒå‘åŒæ­¥æœºåˆ¶ï¼š

```typescript
// åœ¨å‰ç«¯é¡¹ç›®ä¸­æ·»åŠ è„šæœ¬
// sync-api-docs.ts
import * as fs from 'fs';
import * as path from 'path';

// ä»OpenAPIè§„èŒƒæ›´æ–°å‰ç«¯Mock
function updateMockFromOpenAPI(openapiPath) {
  const openapi = JSON.parse(fs.readFileSync(openapiPath, 'utf8'));
  
  // æ›´æ–°å‰ç«¯Mockå®ç°
  // ...
}

// ä»å‰ç«¯Mockæ›´æ–°OpenAPIè§„èŒƒ
function updateOpenAPIFromMock() {
  // æå–Mockä¿¡æ¯å¹¶æ›´æ–°OpenAPIè§„èŒƒ
  // ...
}

// æ ¹æ®å‚æ•°å†³å®šåŒæ­¥æ–¹å‘
const direction = process.argv[2] || 'both';
const openapiPath = path.join(__dirname, '../webService/src/api/swagger.json');

if (direction === 'frontend' || direction === 'both') {
  updateMockFromOpenAPI(openapiPath);
  console.log('Updated frontend Mock from OpenAPI');
}

if (direction === 'backend' || direction === 'both') {
  updateOpenAPIFromMock();
  console.log('Updated OpenAPI from frontend Mock');
}
```

### 2. é›†æˆåˆ°å¼€å‘è„šæœ¬

åœ¨package.jsonä¸­æ·»åŠ åŒæ­¥è„šæœ¬ï¼š

```json
{
  "scripts": {
    "sync-api": "ts-node scripts/sync-api-docs.ts",
    "sync-api:frontend": "ts-node scripts/sync-api-docs.ts frontend",
    "sync-api:backend": "ts-node scripts/sync-api-docs.ts backend"
  }
}
```

## å…­ã€ä¸»è¦Mock APIå®ç°ç¤ºä¾‹

ä»¥ä¸‹æ˜¯å‰ç«¯å·²å®ç°çš„ä¸»è¦Mock APIï¼Œåç«¯å®ç°å¿…é¡»ä¸è¿™äº›APIä¿æŒä¸€è‡´ï¼š

### 1. æ•°æ®æºæ¨¡å—
- `getDataSources`: è·å–æ•°æ®æºåˆ—è¡¨
- `getDataSource`: è·å–å•ä¸ªæ•°æ®æº
- `createDataSource`: åˆ›å»ºæ•°æ®æº
- `updateDataSource`: æ›´æ–°æ•°æ®æº
- `deleteDataSource`: åˆ é™¤æ•°æ®æº
- `testConnection`: æµ‹è¯•è¿æ¥
- `syncMetadata`: åŒæ­¥å…ƒæ•°æ®

### 2. æŸ¥è¯¢æ¨¡å—
- `executeQuery`: æ‰§è¡ŒSQLæŸ¥è¯¢
- `executeNaturalLanguageQuery`: æ‰§è¡Œè‡ªç„¶è¯­è¨€æŸ¥è¯¢
- `cancelQuery`: å–æ¶ˆæŸ¥è¯¢
- `getQueryStatus`: è·å–æŸ¥è¯¢çŠ¶æ€
- `getQueryHistory`: è·å–æŸ¥è¯¢å†å²
- `getQuery`: è·å–å•ä¸ªæŸ¥è¯¢è¯¦æƒ…
- `saveQuery`: ä¿å­˜æŸ¥è¯¢

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¸¥æ ¼çš„å‰åç«¯å¯¹æ¥è§„èŒƒå’Œå·¥å…·æ”¯æŒï¼Œæˆ‘ä»¬èƒ½ç¡®ä¿åç«¯å®ç°ä¸å‰ç«¯Mockä¿æŒé«˜åº¦ä¸€è‡´æ€§ï¼Œå‡å°‘å‰åç«¯å¯¹æ¥æ‘©æ“¦ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚æ¯å½“å‰ç«¯Mockå‘ç”Ÿå˜åŒ–æ—¶ï¼Œåç«¯èƒ½ç«‹å³æ„ŸçŸ¥å¹¶åŒæ­¥æ›´æ–°å®ç°ã€‚