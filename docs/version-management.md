# 查询版本控制与状态管理

## 概述

查询版本控制与状态管理功能是DataScope的核心能力之一，旨在提供完整的查询生命周期管理，支持团队协作、变更追踪和工作流审批。本文档详细介绍此功能的设计理念、使用方法和技术实现。

## 功能特性

### 版本控制

- **完整版本历史**：记录查询的所有历史版本，包括变更内容、时间和作者
- **版本比较**：直观比较不同版本之间的SQL差异、参数变化和元数据变更
- **版本分支**：支持从任意版本创建新版本，形成版本分支
- **版本标记**：为重要版本添加标签和说明，便于后续查找和管理
- **版本导出/导入**：支持版本导出和导入，便于在不同环境间迁移

### 状态管理

- **完整工作流**：支持查询从草稿到发布的完整生命周期
  - 草稿（Draft）：初始创建或修改的版本
  - 审核中（Review）：已提交等待审核的版本
  - 已批准（Approved）：通过审核的版本
  - 已发布（Published）：正式发布到生产环境的版本
  - 已弃用（Deprecated）：不再推荐使用的版本
  - 已归档（Archived）：已归档不可修改的版本
- **状态转换控制**：基于角色和权限的状态转换控制
- **状态历史记录**：完整记录状态变更历史，包括操作人、时间和备注
- **状态通知**：支持状态变更通知和提醒

## 用户指南

### 版本管理

#### 创建新版本

1. 在查询详情页点击"创建新版本"按钮
2. 填写版本名称、说明和变更记录
3. 修改SQL语句和参数配置
4. 提交创建新版本

#### 查看版本历史

1. 在查询详情页切换到"版本历史"标签
2. 查看所有历史版本列表，包括版本号、创建时间、作者和变更说明
3. 点击特定版本可查看详情

#### 比较版本

1. 在版本历史列表中选择两个要比较的版本
2. 点击"比较版本"按钮
3. 在比较界面查看SQL差异、元数据变更和参数变化

#### 添加版本标签

1. 在版本历史列表中选择要标记的版本
2. 点击"添加标签"按钮
3. 填写标签名称、类型和备注
4. 提交保存标签

### 状态管理

#### 更改版本状态

1. 在查询详情页查看当前状态
2. 点击"管理状态"按钮打开状态管理面板
3. 选择目标状态（如从"草稿"提交到"审核中"）
4. 添加状态变更说明（可选）
5. 确认状态变更

#### 查看状态历史

1. 在查询详情页的状态管理面板中
2. 切换到"状态变更历史"部分
3. 查看完整的状态变更记录，包括每次变更的操作人、时间和备注

## 技术实现

### 前端组件

- **VersionCompare.vue**：版本比较组件，使用Monaco Editor实现SQL差异对比
- **VersionHistory.vue**：版本历史列表组件，展示版本列表和操作
- **VersionTagging.vue**：版本标记组件，支持添加和管理标签
- **VersionStatusManager.vue**：状态管理组件，实现状态转换和历史查看
- **CreateVersionDialog.vue**：版本创建对话框，支持版本信息编辑和参数配置

### 服务与API

- **queryVersionService.ts**：前端版本管理服务，封装与后端API的交互
- 主要API端点：
  - `GET /api/queries/:queryId/versions`：获取查询版本列表
  - `POST /api/queries/:queryId/versions`：创建新版本
  - `GET /api/queries/:queryId/versions/compare`：比较两个版本
  - `POST /api/queries/:queryId/versions/:versionId/status`：更改版本状态
  - `GET /api/queries/:queryId/versions/:versionId/status-history`：获取状态历史

### 数据结构

- **QueryVersion**：版本信息，包含SQL、参数、状态等
- **VersionTag**：版本标签，包含名称、类型和备注
- **StatusHistory**：状态历史记录，包含状态变更详情

## 最佳实践

### 版本命名规范

- 使用具有描述性的版本名称，如"添加用户过滤功能"
- 对于重要版本，添加标签并写明详细说明
- 使用标准化的变更描述，便于后续追踪

### 状态管理建议

- 严格控制状态转换权限，特别是批准和发布权限
- 为每次状态变更添加详细说明，特别是拒绝或退回操作
- 定期审查和归档不再使用的查询版本

### 团队协作流程

- 开发人员创建和修改查询，提交到审核状态
- 审核人员检查查询并决定批准或退回
- 管理员负责将批准的查询发布到生产环境
- 使用标签标记重要里程碑版本，如"v1.0正式发布"

## 常见问题解答

### Q: 已经发布的版本可以修改吗？
A: 已发布的版本不能直接修改。您需要基于发布版本创建新版本进行修改，修改完成后通过审核流程发布新版本。

### Q: 如何将旧版查询迁移到版本控制系统？
A: 系统会自动将现有查询转换为版本控制模式，将当前查询内容作为第一个版本。

### Q: 如何处理版本冲突？
A: 当多人同时修改同一查询时，系统会检测版本冲突。后提交的版本需要手动解决冲突，通常建议基于最新版本创建新版本。

### Q: 状态变更需要什么权限？
A: 不同状态变更需要不同权限：
- 提交审核：查询创建者和编辑者
- 批准查询：审核员和管理员
- 发布查询：管理员
- 弃用和归档：管理员

## 后续计划

- 增加版本分支合并功能
- 添加版本依赖关系管理
- 实现自动化测试集成
- 支持变更通知和订阅
- 增强协作和评论功能