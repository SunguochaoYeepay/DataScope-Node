# 更新日志

## [未发布]

### 优化
- 统一Swagger API文档中的路径格式和分组标签
  - 修改API路径，确保所有Swagger路径都带有`/api`前缀
  - 修正了`datasource.routes.ts`中`/datasources/{id}/stats`路径为`/api/datasources/{id}/stats`
  - 修正了`datasource.routes.ts`中`/datasources/test`路径为`/api/datasources/test`
  - 修正了`datasource.routes.ts`中`/datasources/{id}/test`路径为`/api/datasources/{id}/test`
  - 修正了`datasource.routes.ts`中`/datasources/{id}/check-status`路径为`/api/datasources/{id}/check-status`
  - 修正了`query.routes.ts`中`/queries`路径为`/api/queries`
  - 统一了API文档中的标签分组，将单数形式的`DataSource`改为复数形式`DataSources`，确保所有数据源相关API端点都在同一分组下
  - 保持了所有API文档中路径格式一致性
  - 提高了API文档的可读性和一致性，确保文档与实际请求路径保持一致

- 统一了数据源API路径格式
  - 移除了带连字符的`/api/data-sources`路径，只保留标准格式`/api/datasources`
  - 更新了相关文档和测试脚本，确保使用统一的路径格式
  - 保持与其他API路径命名风格一致
  - 减少了冗余和混淆，提高了API路径的一致性

### 安全优化
- 移除了示例错误路由
  - 删除了`/api/examples/errors`系列路由，包括各种错误类型演示端点
  - 从路由注册文件中移除了`examplesRouter`的引用和注册
  - 保留了示例代码文件供开发者参考，但不再对外暴露API端点
  - 修改了示例路由文件，移除了Swagger注释，并将文件重命名为`.bak`后缀，确保不会出现在API文档中
  - 提高了系统安全性，避免暴露内部错误处理机制

### 修复
- 彻底修复了启用/禁用查询的问题
  - 前端修改：
    - 修改`QueryListView.vue`中的`toggleQueryStatus`方法，直接操作`serviceStatus`而非间接设置`status`
    - 更新了`updateQueryStatus`方法，现在直接接收和处理`serviceStatus`参数
    - 优化了查询状态更新流程，确保前端与后端状态字段匹配
    - 增加了`QueryServiceStatus`类型定义，明确区分查询状态和服务状态两个概念
  - 后端修改：
    - 修复`updateQuery`方法，增加对`status`和`serviceStatus`参数的支持
    - 完善状态一致性处理逻辑，确保状态变更时两个字段保持同步
    - 增强日志记录，详细跟踪状态变更过程
    - 添加参数验证，确保状态字段值符合预期

- 清理前端mock数据，确保使用真实的后端API调用
  - 修复各函数，使用后端真实数据而不是mock数据
  - 修复查询状态更新请求缺少状态参数的问题，添加status字段到请求体
  - 修复在saveQuery方法中处理serviceStatus字段，确保正确记录用于调试
  - 更新savedQuery对象创建逻辑，正确处理后端status和serviceStatus字段

- 彻底清理前端模拟数据，确保使用真实的后端API调用
- 替换 `QueryVersionDetail.vue` 中使用的模拟数据，包括版本信息、执行历史和版本激活功能
- 修复 `loadVersionData` 函数，使用 `versionService.getVersion` 获取真实数据
- 修复 `loadExecutionHistory` 函数，使用 `queryService.getQueryExecutionHistory` 获取真实数据
- 修复 `handleActivate` 函数，使用 `versionService.activateVersion` 执行真实API调用
- 修复查询列表页面的启用/禁用功能，使其调用真实的后端API而不是只修改前端状态
- 修复查询列表状态更新问题
  - 更正 `updateQueryStatus` 方法，使用 `saveQuery` 接口正确更新查询状态
  - 修复 `confirmStatusChange` 函数中对返回结果的处理逻辑，不再检查返回是否为空
  - 增强状态更新日志记录，便于调试
- 修复 `queryService.updateQuery is not a function` 错误
  - 添加 `updateQuery` 方法作为 `saveQuery` 的别名，确保 API 兼容性
  - 保证查询启用/禁用功能可以正常工作
- 修复查询状态更新请求丢失状态参数问题
  - 在 `saveQuery` 方法中添加 `status` 字段到请求体中
  - 修复 `savedQuery` 对象的创建，正确处理后端返回的 `status` 和 `serviceStatus` 字段
  - 确保禁用查询时正确传递 `DEPRECATED` 状态
- 修复查询启用/禁用功能不生效问题
  - 发现前端和后端概念不匹配：`status`(DRAFT/PUBLISHED/DEPRECATED)控制生命周期，`serviceStatus`(ENABLED/DISABLED)控制可用性
  - 修改 `saveQuery` 方法，同时设置 `serviceStatus` 参数
  - 更新 `updateQueryStatus` 方法，直接发送明确的服务状态
  - 修正 `SaveQueryParams` 接口，添加 `serviceStatus` 字段

## 2024-03-26

### 修改

- 移除了查询相关的标签功能
  - 从Query类型定义中移除了tags字段
  - 从SaveQueryParams类型定义中移除了tags字段
  - 从保存查询对话框中移除了标签输入部分

### 修复

- 修复了保存查询接口的问题
  - 修正了请求体中的字段名（将queryText改为sql）
  - 确保正确传递dataSourceId
  - 移除了不必要的字段（queryType）
  - 优化了类型定义，使其与后端API保持一致
  - 修复了数据源ID未正确传递的问题
  - 确保返回的Query对象包含所有必需字段
  - 优化了错误处理，对查询不存在的情况提供更友好的错误提示
  - 添加了必填字段的前端验证
  - 优化了错误消息的显示，提供更具体的错误信息
  - 修复了服务层saveQuery方法字段名不匹配的问题

- 修复了新增查询场景的问题
  - 修正了新增查询时错误使用PUT方法的问题
  - 确保新增场景不传入id字段
  - 只在更新场景下使用路由中的queryId

- 修复了查询编辑功能问题
  - 修复了编辑页面无法正确加载已有查询的问题
  - 确保URL中的查询ID能正确传递到组件中
  - 优化了查询加载逻辑，改进错误处理和提示
  - 修复了查询内容无法正确回显的问题

- 修复了查询保存界面的问题，调整请求体格式以符合后端API要求
- 修复了查询编辑页面载入时间过长的问题
- 修复了数据源选择后执行查询时数据源ID未正确传递的问题
  - 增加了数据源选择变更检测和状态同步
  - 执行查询前增加了数据源ID验证
  - 确保在API请求中使用正确的字段名称
- 修改了查询执行和保存逻辑，确保符合后端API要求
- 优化了错误处理，提供更友好的错误提示

## 2023-11-23

### 修复

- 修复了新增查询页面版本信息不显示的问题
  - 优化了版本号显示组件，使版本号更清晰可见
  - 增加了新增查询时的版本状态显示（"草稿"）
  - 确保版本列表始终不为空，至少包含"V1"版本
  - 改进了版本号的初始化和更新逻辑

## 2024-04-03

### 新增

- 优化了查询详情页和版本详情的展示逻辑
  - 在查询详情页添加了活跃版本信息区域
  - 明确标识了执行历史、可视化等标签页的数据来源于活跃版本
  - 支持通过版本历史页面查看特定版本的详情
  - 改进了版本信息的展示布局和用户体验
- 新增了独立的查询版本详情页面
  - 创建了专门的路由 `/query/detail/:id/version/:versionId`
  - 支持查看特定版本的执行历史、执行计划等信息
  - 提供了从查询详情返回的导航和版本设置为活跃的功能
  - 明确区分了查询详情和版本详情的概念模型
- 完善了查询列表页的启用/禁用功能
  - 实现了查询启用/禁用的后端API调用
  - 添加了查询状态更新接口
  - 优化了状态切换的用户交互体验
- 改进了查询列表的筛选和分页功能
  - 将前端筛选改为后端API筛选，提高大数据量下的性能
  - 优化了搜索和状态筛选的实现方式
  - 实现了服务器端分页，支持更大数据量的查询列表

### 修复

- 修复了查询列表页版本显示不正确的问题
  - 改进了版本ID格式化方法，正确提取版本号
  - 为每个查询添加默认的当前版本ID
  - 确保列表和详情页版本号保持一致
- 修复了查询列表页与查询详情页版本历史展示不一致的问题
  - 统一了前端版本数据的获取和显示逻辑
  - 确保查询列表和版本历史使用相同的版本号格式
  - 同步了版本状态的展示方式
- 修复了启用/禁用功能状态列显示不正确的问题
  - 优化了状态变更后UI更新逻辑
  - 修改了状态显示判断条件，直接使用status字段而非isActive标志
  - 确保状态变更后视图立即反映最新状态

## 2024-04-05

### 修复

- 修复了查询列表页数据源和查询类型展示问题
  - 将原先合并的"数据源/类型"列分拆为独立的"数据源"和"查询类型"两列
  - 添加了数据源信息回显功能，确保显示正确的数据源名称
  - 优化了查询类型的显示样式，提高可读性
  - 修正了类型和导入路径大小写不一致的问题

## 2024-04-07

### 优化

- 优化了查询列表页的API调用逻辑
  - 引入数据源信息缓存机制，避免重复请求数据源列表
  - 修改初始化流程，先加载数据源缓存后再加载查询列表
  - 将数据源信息补充逻辑改为使用缓存数据，减少API请求次数
  - 优化了查询列表和数据源信息的加载顺序，提高页面加载效率

### 修复

- 修复了查询启用/禁用状态不同步的问题
  - 扩展了状态检查逻辑，同时兼容status和serviceStatus字段
  - 改进了isQueryActive判断方法，支持多种状态组合
  - 修改了toggleQueryStatus方法，使其基于当前活跃状态而非单一字段
  - 解决了更新查询状态后，刷新列表导致状态显示不一致的问题

## [Unreleased]

### Added
- 添加查询列表页面
- 添加查询详情页面
- 添加查询版本管理功能
- 添加查询列表页面刷新按钮，方便用户手动刷新最新数据
- 修改查询版本显示逻辑，优先使用真实API数据，降级为模拟数据作为备选
- 增强查询编辑器功能，重新设计版本管理工作流
  - 保存按钮：创建查询并创建草稿版本
  - 发布按钮：将当前草稿版本发布并激活为当前版本

### Changed
- 优化查询列表UI，移除版本状态筛选，使查询列表专注于查询本身
- 更新查询状态显示，根据serviceStatus字段直接显示服务状态
- 修复版本ID格式化函数，确保正确显示版本号
- 添加查询详情标签页上的版本指示，清晰显示数据来源于活跃版本
- 移除前端生成的模拟版本ID，改为使用后端实际返回的版本数据
- 优化查询详情页版本数据加载逻辑，直接使用API返回数据而非模拟数据
- 优化版本加载逻辑，尝试使用后端版本API，失败后才降级为模拟数据
- 重新设计查询保存和发布流程，使其更符合直觉
  - 保存时只创建草稿版本，不发布或激活
  - 发布时才发布并激活版本
- 优化查询详情页面布局
  - 移除版本列表外层的重复卡片容器
  - 移除重复的新增版本按钮，统一使用页面顶部的按钮
  - 简化版本列表的视觉层级

### Fixed
- 修复query.ts文件中重复声明totalPages变量导致的编译错误
- 修复查询列表按状态筛选不生效的问题，确保serviceStatus参数正确传递到后端API
- 修复查询状态显示不正确的问题，优先使用serviceStatus字段判断查询是否活跃
- 修复查询启用/禁用切换后状态不更新的问题，确保同时更新status和serviceStatus字段
- 修复查询状态更新后页面刷新问题，添加立即刷新功能确保前端状态与后端保持同步
- 修复DRAFT状态查询但serviceStatus为ENABLED的显示错误，优化状态判断逻辑
- 增加直接调用API检查查询状态的功能，确保UI显示与后端数据一致
- 修复查询列表无版本ID时显示错误的问题，确保显示"无版本"而非模拟版本号
- 修复版本列表展示问题，当后端API返回null时正确处理，避免前端展示错误
- 修复查询创建后没有版本信息的问题，通过合理的保存和发布流程确保版本创建
- 修复了创建新查询保存失败的问题，将sql字段正确映射为sqlContent以匹配Prisma模型
- 添加了更详细的错误日志记录，包括错误消息和堆栈信息，以便于调试
- 添加了对空查询名称、数据源ID和SQL内容的验证，防止创建无效的查询记录
- 修复了错误使用versionsCount字段的问题，该字段在Prisma模型中不存在

### 添加

- 查询版本管理优化：
  - 新增一键保存并发布查询 API，简化版本管理流程
  - 修改查询创建逻辑，创建查询的同时自动创建初始版本
  - 完善版本管理流程，支持一次性完成保存、发布和激活操作
  - 前端服务添加版本化保存和发布接口
- 新增自动发布和激活查询版本的功能，简化版本管理流程
  - 创建查询时默认自动发布并激活初始版本
  - 支持通过shouldPublish参数控制是否自动发布
  - 添加了版本发布和激活的日志记录
  - 确保查询创建后立即可用，无需手动发布和激活

## [未发布]

### 新增
- 查询列表页面显示当前活跃版本号和状态

### 修复
- 修复了版本状态不正确的问题
- 改进了后端API，自动返回查询的当前活跃版本信息
- 修复了版本管理页面版本号展示问题，将版本ID改为显示人类可读的版本号格式(如V1、V2)
- 修复了查询详情页面版本列表显示版本ID的问题，改为显示人类可读的版本号
- 修复版本管理页面显示版本ID而不是版本号的问题，现在显示如"V1"、"V2"等更友好的格式
- 修复详情页显示空页面的问题
- 修复路由配置中空路由导致的运行时错误
- 修复查询状态大小写敏感问题，统一处理serviceStatus字段，确保状态正确显示

### 优化
- 简化查询详情页结构，移除底部标签导航，只保留版本历史部分
- 优化查询详情页顶部按钮，只保留编辑和返回列表按钮，移除收藏、分享和执行按钮
- 优化版本列表的显示方式，减少页面复杂度
- 移除版本历史列表页面的冗余标题
- 移除版本列表中的"查看"按钮，简化版本操作功能
- 在版本列表中添加眼睛图标按钮，方便用户快速查看版本详情
- 优化查询列表页操作列，移除收藏和查看版本历史按钮，增加查看详情按钮，使操作更加直观

### 修复
- 修复了查询列表加载失败的问题
  - 在 queryService 中添加了 getQueries 方法，用于获取查询列表
  - 优化了 getQueries 方法的参数处理和返回值处理
  - 增强了错误处理和日志记录，便于调试和排错
  - 修复了 fetchQueries 方法中的响应处理逻辑，正确解析 API 返回的分页数据
- 移除前端模拟数据，使用真实 API
  - 添加了 getQueryExecutionHistory 方法，用于获取查询执行历史
  - 修复了 QueryDetail.vue 中使用模拟执行历史数据的问题
  - 添加了 QueryExecution 类型定义，完善类型系统
  - 改进了错误处理和日志记录，提高代码健壮性
  - 添加了 getVersionExecutionResult 和 getQueryResult 方法，用于获取查询结果
  - 修复了 QueryVersionDetail.vue 中使用模拟数据的问题，包括执行历史、执行计划和查询结果
  - 重构了查询执行逻辑，使用实际的 API 调用代替模拟延时和假数据
