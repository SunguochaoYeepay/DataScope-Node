# 查询服务版本控制与状态管理实施任务分解

## 实施目标

实现查询服务的版本控制和状态管理功能，确保查询服务的变更可追踪、可回滚，并支持紧急禁用功能。

## 后端开发任务

### 1. 数据库结构变更

- [ ] 设计并执行查询服务主表(queries)结构变更脚本
- [ ] 创建查询版本表(query_versions)
- [ ] 修改查询历史表(query_history)结构
- [ ] 实现数据迁移脚本，为现有查询创建v1版本
- [ ] 设计和实现必要的数据库索引

### 2. 基础服务层实现

- [ ] 实现查询版本管理服务(QueryVersionService)
  - [ ] 创建版本
  - [ ] 更新版本
  - [ ] 发布版本
  - [ ] 废弃版本
  - [ ] 设置活跃版本

- [ ] 实现查询状态管理服务(QueryStatusService)
  - [ ] 禁用查询服务
  - [ ] 启用查询服务
  - [ ] 状态检查逻辑

- [ ] 优化查询执行服务(QueryExecutionService)
  - [ ] 执行前状态检查
  - [ ] 支持特定版本执行
  - [ ] 执行记录与版本关联

- [ ] 查询历史服务优化(QueryHistoryService)
  - [ ] 关联查询与版本
  - [ ] 移除清空历史功能
  - [ ] 记录执行性能指标

### 3. API接口实现

- [ ] 查询服务管理接口
  - [ ] 创建查询服务(DRAFT状态)
  - [ ] 获取查询服务列表(支持状态过滤)
  - [ ] 获取查询服务详情(包含版本列表)
  - [ ] 更新查询服务基本信息

- [ ] 版本管理接口
  - [ ] 创建新草稿版本
  - [ ] 获取版本列表
  - [ ] 获取版本详情
  - [ ] 更新草稿版本
  - [ ] 发布/废弃/激活版本

- [ ] 状态管理接口
  - [ ] 禁用查询服务
  - [ ] 启用查询服务
  - [ ] 获取查询服务状态

- [ ] 查询执行接口
  - [ ] 执行当前活跃版本
  - [ ] 执行指定版本

- [ ] 查询历史接口
  - [ ] 获取特定查询服务历史
  - [ ] 获取全局查询历史(移除删除功能)

### 4. 单元测试与集成测试

- [ ] 版本管理功能单元测试
- [ ] 状态管理功能单元测试
- [ ] 查询执行功能集成测试
- [ ] 历史记录功能测试
- [ ] API接口测试

## 前端开发任务

### 1. 组件设计与实现

- [ ] 查询服务状态组件
  - [ ] 状态指示器
  - [ ] 启用/禁用开关
  - [ ] 禁用原因输入表单

- [ ] 版本管理组件
  - [ ] 版本列表组件
  - [ ] 版本状态标识
  - [ ] 版本操作按钮组
  - [ ] 当前活跃版本标识

- [ ] 查询编辑器组件优化
  - [ ] 版本状态显示
  - [ ] 草稿保存/发布按钮
  - [ ] 草稿编辑限制逻辑

- [ ] 查询历史组件优化
  - [ ] 增加版本信息显示
  - [ ] 执行性能指标展示
  - [ ] 移除删除按钮

### 2. 页面优化

- [ ] 查询服务列表页优化
  - [ ] 增加状态列显示
  - [ ] 添加版本信息显示
  - [ ] 列表筛选功能增强

- [ ] 查询服务详情页重构
  - [ ] 服务基本信息区域
  - [ ] 版本管理区域
  - [ ] 查询编辑区域
  - [ ] 查询历史区域

- [ ] 新增版本管理页面
  - [ ] 版本列表视图
  - [ ] 版本对比功能
  - [ ] 版本操作界面

### 3. 状态管理与API集成

- [ ] 查询服务状态管理
  - [ ] 查询服务状态API集成
  - [ ] 状态变更操作处理
  - [ ] 状态变更确认流程

- [ ] 版本管理状态
  - [ ] 版本列表API集成
  - [ ] 版本操作API集成
  - [ ] 版本编辑状态管理

- [ ] 查询执行状态
  - [ ] 版本执行API集成
  - [ ] 执行状态与结果处理
  - [ ] 执行错误处理

### 4. 用户体验优化

- [ ] 操作指引设计
  - [ ] 版本管理操作指引
  - [ ] 状态变更操作提示
  - [ ] 错误处理与提示

- [ ] 交互流程优化
  - [ ] 版本创建与发布流程
  - [ ] 禁用确认流程
  - [ ] 版本切换流程

- [ ] UI设计与实现
  - [ ] 状态颜色与图标设计
  - [ ] 版本标识设计
  - [ ] 操作按钮与交互设计

### 5. 测试与验证

- [ ] 组件单元测试
- [ ] 页面集成测试
- [ ] 用户流程测试
- [ ] 兼容性测试

## 协作事项

### 1. 接口协议定义

- [ ] 确定查询服务API响应格式
- [ ] 确定版本相关字段定义
- [ ] 确定状态相关字段定义
- [ ] 确定错误处理机制

### 2. 联调计划

- [ ] 基础服务层API联调
- [ ] 版本管理功能联调
- [ ] 状态管理功能联调
- [ ] 查询执行功能联调

### 3. 测试与上线

- [ ] 制定测试计划
- [ ] 执行集成测试
- [ ] 准备回滚方案
- [ ] 制定分阶段上线计划