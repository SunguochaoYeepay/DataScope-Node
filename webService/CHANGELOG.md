# 更新日志

## [未发布] - 2025-04-10

### 最新更新

- 修复版本激活功能中当前活跃版本状态不正确更新的问题
- 增强激活路由和版本格式中间件的调试日志
- 修复版本激活时当前版本ID不正确传递的问题
- 增强前端版本管理组件的调试日志
- 修复前端版本列表空数据时的显示问题
- 修复 query-version.routes.ts 中的 TypeScript 类型错误，添加类型安全检查并防止空值设置

### 新增

- 添加查询版本控制功能，支持查询草稿、发布、废弃和活跃版本管理
- 添加查询服务状态管理，支持启用和禁用查询服务
- 添加查询执行历史记录，支持按版本查询历史
- 添加查询收藏功能，支持用户收藏和取消收藏查询
- 更新Swagger文档，添加查询版本控制、服务状态管理和收藏相关接口的详细说明
- 增加完整API文档，整合所有接口到一个统一的规范文件
- 添加测试数据源连接接口，支持多种数据库类型的连接测试
- 添加查询列表筛选选项，支持通过`includeDrafts`参数选择是否显示草稿状态的查询
- 在Docker容器中创建了电商示例数据库（ecommerce_demo），包含customers、products、orders和order_items表以及示例数据，方便测试和演示
- 新增版本数据格式转换中间件，统一后端返回的版本数据格式，确保与前端期望的格式一致
- 新增版本激活路由，支持用户将特定版本设置为活跃版本

### 优化

- 优化数据库模型，添加查询版本表和查询收藏表
- 优化错误处理，添加查询版本相关的错误码
- 优化API文档，重新组织接口分类
- 改进Swagger UI配置，提升API文档可读性
- 优化Swagger配置，支持同时访问新旧文档
- 优化数据源接口，支持双路径访问模式
- 重构查询执行逻辑，将执行操作与历史记录创建分离
- 优化查询管理功能，防止隐式创建查询，提高操作透明度
- 改进查询列表接口，默认只返回已发布的查询
- 统一查询编辑器中的执行按钮样式，提升用户体验一致性
- 修改前端查询列表API调用，默认请求包含草稿状态的查询(includeDrafts=true)，使用户可以看到所有保存的查询
- 优化查询详情页面布局，将执行历史从底部移至基本信息面板右侧，采用紧凑卡片形式展示，提升页面空间利用率
- 在查询详情页面执行历史标题旁添加刷新按钮，方便用户手动刷新执行历史数据
- 重新布局查询详情页面操作按钮，将收藏/分享、编辑/执行和返回按钮分组放置在页面顶部，提高按钮可访问性
- 优化查询详情页面布局，将执行历史移至底部标签页中，与其他功能模块保持一致的交互方式和展示形式
- 改进版本管理API路由结构，使路由路径与前端调用一致，提高开发体验
- 优化版本格式转换中间件，确保只对版本相关的路由应用转换，避免影响其他API响应
- 优化路由注册，实现API路径前缀和非前缀路径的双重支持，解决前端直接访问和通过API访问的差异问题

### 修复

- 修复Swagger文档加载路径问题
- 修复API文档安全策略配置
- 修复数据源接口文档缺失问题
- 修复前端无法查看完整接口文档的问题
- 修复数据源连接测试接口缺失问题
- 修复 auth.middleware.ts 和 auth.ts 之间的导入冲突问题
- 修复 folder.routes.ts 和 system.routes.ts 的中间件导入问题
- 修复 folder.controller.ts 中错误码使用问题
- 修复 auth.ts 中的类型安全问题
- 修复 app.ts 中导出问题
- 修复 datasource.controller.ts 中 ApiError 的使用和 ErrorCode 导入问题
- 修复未保存的查询显示在查询列表的问题，现在默认只显示已发布的查询
- 修复前端查询编辑器中"返回列表"按钮导航到错误路径的问题
- 修复Prisma客户端连接配置，改为从环境变量获取数据库URL
- 更新数据源服务和监控服务Prisma实例，使用相同的数据库连接URL
- 修复模拟数据模式下仍尝试连接数据库的问题
- 修复数据源服务中Prisma客户端连接问题，添加显式数据库连接配置
- 修复编译后JavaScript代码与TypeScript源代码不同步问题，确保重新编译后正确处理认证中间件导入
- 修复package.json中的启动脚本配置，将入口文件从app.ts更正为index.ts
- 删除不可用的示例数据源（"Docker示例数据库/sample_db"），防止前端查询失败
- 修复查询保存后在查询列表中不显示的问题，通过前端代码修改，默认请求包含草稿状态的查询
- 修复查询版本管理页面加载错误问题，添加了访问路径为 `query/version/management/:queryId` 的路由支持
- 确保与前端查询版本管理页面API调用路径一致
- 添加缺失的 QueryVersion 数据模型，支持查询版本管理功能
- 修复 query-version.service.ts 文件中的 TypeScript 类型错误
- 修复前端版本管理页面调用问题，添加了 versionService 服务以连接后端API
- 修复版本管理路由缺失问题，添加完整的版本管理路由和中间件注册
- 修复版本数据格式不一致问题，通过添加格式转换中间件确保前后端数据结构一致
- 修复格式转换中间件影响查询列表API的问题，通过添加路径检查确保只对版本相关路由应用格式转换
- 修复前端版本管理页面空数据显示问题，增强了版本列表API的空响应处理
- 修复前端直接访问版本管理页面路径与API路径不一致的问题，提供了双路径支持和扩展的路径检测逻辑

### 功能修复

- 修复查询保存后在查询列表中不显示的问题 - 默认只显示状态为PUBLISHED的查询，需要传递isPublic=true或在前端指定状态为已发布
- 添加了MySQL视图查询支持和执行计划获取功能

## [1.0.2] - 2025-04-02

### 修复
- 修复了USE_MOCK_DATA=true设置后仍然尝试连接数据库的问题
- 创建了集中式Prisma客户端管理模块，支持模拟数据模式
- 修改了数据源服务和数据源监控服务，使用新的Prisma客户端实例
- 添加了启动脚本`start-with-mock.sh`，简化使用模拟数据启动应用的流程