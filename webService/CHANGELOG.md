# 更新日志 (CHANGELOG)

所有对项目的显著更改都将记录在此文件中。

## [1.0.9] - 2024-05-07

### 修复
- 修复数据源连接测试API接口 `/api/datasources/:id/test`
- 修复元数据路由，统一为 `/api/metadata/datasources/:dataSourceId/tables`
- 确保API服务监听5000端口
- 优化主机名解析，自动将容器名转换为localhost
- 修复Swagger API文档配置

### 改进
- 简化认证中间件，支持开发环境跳过验证
- 优化错误处理，提供更详细的错误信息
- 优化数据源连接参数处理

## [1.0.8] - 2024-05-07

### 改进
- 从Git仓库中移除dist编译目录，优化代码仓库大小和结构
- 完善.gitignore规则，忽略编译输出目录
- 提升代码仓库的维护性，降低不必要的文件追踪

## [1.0.0] - 2023-03-29

### 新功能 (New Features)

- 实现数据源管理功能
  - 创建、查询、更新和删除数据源
  - 数据源连接测试
  - 支持MySQL数据库类型
- 实现查询执行功能
  - SQL查询执行
  - 查询结果展示
  - 查询历史记录
- 实现元数据查询功能
  - 数据库表结构查询
  - 数据库字段信息查询
  - 数据库关系查询
- 实现查询管理功能
  - 保存查询
  - 管理查询历史
- 添加API文档 (Swagger)
- 健康检查接口

### 修复 (Fixes)

- 修复了错误处理中间件类型问题
- 修复了数据源服务中的类型错误
- 修复了Swagger文档配置问题
- 修复了数据库databaseName与database字段不一致问题
- 密码加密存储问题的修复

### 变更 (Changes)

- 改进了数据源密码的安全处理
- 更新了API错误处理机制
- 改进了查询执行服务的性能
- 调整了中间件结构

### 安全 (Security)

- 增强了错误处理机制，防止敏感信息泄露
- 实现了数据源密码的加密存储
- 添加了请求验证和参数校验

## [1.0.1] - 2023-03-30

### 新功能 (New Features)

- 实现元数据同步功能
  - 支持全量和增量同步
  - 可配置同步的schema和表范围
  - 记录同步历史
  - 同步表、视图、列和关系信息
- 实现元数据结构查询功能
  - 获取完整的数据源元数据结构
  - 支持表数据预览
  - 查询同步历史
- 优化元数据API路由设计
  - 简化路由结构
  - 添加详细参数验证

### 修复 (Fixes)

- 修复了元数据控制器中的类型错误
- 修复了元数据路由中的验证问题
- 修复了数据源连接器接口不一致问题

### 变更 (Changes)

- 重构了元数据服务的API设计
- 优化了同步性能和错误处理
- 改进了元数据存储结构

## [1.0.2] - 2024-03-30

### 修复
- 修复了datasource控制器测试，重写了测试代码以正确模拟模块和依赖关系
- 修复了测试中的服务层模拟问题，确保控制器能够正确调用和处理服务层方法
- 优化了测试覆盖率，所有测试现在都可以正常通过
- 修复了query控制器测试，使用JavaScript编写并正确模拟了所有依赖项

## [1.0.3] - 2024-04-17

### 修复 (Fixes)
- 修复了MySQL连接器（mysql.connector.ts）中的问题：
  - 删除了无效的execute方法，该方法使用了不存在的connection对象
  - 使用正确的executeQuery方法代替，确保所有数据库操作都能正常工作
- 修复了query-plan.controller.test.js测试文件中的模拟问题：
  - 修正了PrismaClient模拟实现，使其返回合适的查询计划数据
  - 补全了getQueryPlanHistory和getQueryPlanById测试中缺失的模拟方法调用
  - 完善了comparePlans测试，添加了正确的数据模拟和验证逻辑
  - 解决了所有测试断言失败问题
- 全部修复关键控制器的测试，包括：
  - datasource.controller.test.js - 17个测试全部通过
  - query.controller.test.js - 16个测试全部通过
  - query-plan.controller.test.js - 10个测试全部通过
- 增强了测试文件的鲁棒性，使用更严格的验证逻辑

### 变更 (Changes)
- 优化了测试代码组织，确保每个测试函数独立设置依赖并清理模拟状态
- 添加了更详细的测试覆盖，确保所有控制器方法都有成功和失败场景的测试
- 改进了模拟对象结构，更准确地反映实际应用程序行为

## [1.0.5] - 2024-05-01

### 修复 (Fixes)
- 解决了元数据同步接口问题：
  - 改进了数据源连接中的主机名解析，支持更多容器名称解析为localhost
  - 增加空主机名检测和默认值(127.0.0.1)处理
  - 添加IP地址格式检测，避免对已是IP地址的主机名进行不必要的解析
- 增强了数据源连接测试机制：
  - 添加连接失败重试功能，默认重试3次
  - 实现了退避策略，每次重试增加延迟时间
  - 添加了详细的连接尝试日志记录
- 统一了数据源ID验证机制：
  - 修改了所有API接口的数据源ID验证，从严格UUID格式改为简单的非空字符串验证
  - 更新了metadata.controller.ts中的验证方法
  - 更新了plan-visualization.routes.ts中的查询计划ID验证
  - 更新了datasource.validator.ts中的所有ID验证规则

### 性能优化
- 改进了数据源连接测试性能，通过重试机制提高了不稳定环境下的连接成功率
- 优化了主机名解析逻辑，减少了DNS查询需求

### 变更 (Changes)
- 统一了API接口验证标准，提高了系统对各种ID格式的兼容性
- 增强了系统在不同网络环境下的适应性

## [1.0.4] - 2024-04-30

### 修复 (Fixes)
- 修复了MySQL连接器对特殊命令的处理问题：
  - 扩展isSpecialCommand方法，增加了更多特殊命令的识别，如SHOW DATABASES、SHOW TABLES等
  - 添加对无分号结尾的命令的支持
  - 完善了特殊命令集合，增加了SHOW COLUMNS、SHOW INDEX、SET、USE等命令
- 修复了控制器处理查询的问题：
  - 在query.controller.ts中增加了特殊命令检测，避免特殊命令添加分页参数
  - 优化了查询执行方法中的参数处理逻辑
- 修复了数据源ID验证问题：
  - 删除了路由中对dataSourceId的UUID格式验证，改为简单的非空验证
  - 使系统能够支持非UUID格式的数据源ID

### 性能优化
- 优化了查询执行过程，避免对特殊命令添加不必要的处理
- 减少了特殊命令执行时的数据库负荷

### 变更 (Changes)
- 改进了API接口的异常处理，提供更明确的错误信息
- 提高了系统对非标准命令的容错性

### 待实现功能

- 用户认证和授权
- 数据可视化功能
- 数据导出功能
- 定时查询功能
- 完整的测试用例

## [1.0.7] - 2024-05-03

### 新增
- 为前端开发人员全面升级《前端开发对接指南》文档
- 添加完整快速开始代码示例，覆盖常见使用场景
- 新增数据源连接规则详细说明文档
- 添加查询模块API详解文档，包含完整的请求/响应示例
- 添加查询收藏功能的API接口实现
- 添加标准表元数据API路径(/api/metadata/{dataSourceId}/tables)

### 改进
- 完善前端错误处理指南，添加错误码列表和处理建议
- 细化数据源ID规则说明，增强API使用灵活性
- 改进文档结构和示例代码格式
- 增强查询API文档，添加JavaScript使用示例
- 修复获取查询收藏列表API返回500错误的问题
- 修复数据源连接测试功能中容器名称解析问题
- 修复数据库名称字段不一致问题，统一使用database参数

### 文档
- 新增主机名解析机制详细说明
- 添加连接重试机制和超时处理文档
- 优化API使用示例，增加实际应用场景
- 完善查询执行、历史记录和保存查询API文档
- 添加查询收藏功能的API接口文档和使用示例
- 更新API路径说明，确保前后端接口匹配
- 添加元数据API接口路径说明，明确/api/metadata/{dataSourceId}/tables为获取表列表的标准路径

### API路径修复
- `/api/metadata/{dataSourceId}/tables`: 标准路径获取表列表
- `/api/metadata/{dataSourceId}/tables/{tableName}`: 标准路径获取表结构
- `/api/queries/favorites`: 收藏查询列表
- `/api/queries/{id}/favorite`: 添加/移除收藏

## 更新日志 (2025-03-31)

### 新增功能

- 添加简化版元数据API路径: `/api/metadata/{dataSourceId}/tables` 和 `/api/metadata/{dataSourceId}/tables/{tableName}`，支持前端兼容性

### 修复问题

- **数据库连接问题**: 修复了数据库连接器在容器环境和本地环境中的主机名解析问题，现在系统会根据环境变量 `CONTAINER_ENV` 自动将容器名称解析为 localhost 或实际容器名
- **元数据同步问题**: 修复了元数据同步接口中使用原始 SQL 查询导致的语法错误问题，改用 Prisma ORM API
- **元数据表丢失问题**: 使用 `prisma db push` 同步了数据库架构，确保元数据表 `tbl_metadata` 存在
- **特殊SQL命令处理问题**: 修复了MySQL连接器中对特殊命令（如SHOW TABLES）的处理，确保不对特殊命令添加LIMIT子句

### 提升服务稳定性

- 增强了数据库连接器的日志输出，方便故障排查
- 在多个数据库连接点统一使用主机名解析逻辑
- 修复 `createConnectorFromDataSourceId` 和 `createConnector` 方法中的容器名称处理逻辑
- 改进了MySQL连接器中对SQL查询的处理，包括更精确的排序和分页应用条件

## 更新日志 (之前)

### v1.0.7 - 2023-11-22
- 修复 MetadataService 中的重复代码和导入问题
- 修复 API 控制器中的类型错误
- 解决 Database 工具类中的 SSL 类型不兼容问题
- 优化应用启动流程，实现路由动态加载
- 修复应用构建过程中的类型错误

### v1.0.6 - 2023-11-20
- 添加查询收藏功能接口
- 完善数据源连接测试机制
- 改进元数据API路径结构

### v1.0.5 - 2023-11-18
- 添加Docker测试环境，支持MySQL, PostgreSQL和MariaDB
- 完善前端集成文档，提供开发指南
- 改进API查询历史记录功能

### v1.0.4 - 2023-11-16
- 修复数据源连接测试功能
- 增加智能主机名称解析
- 提升数据库连接成功率

### v1.0.3 - 2023-11-14
- 统一API接口返回格式
- 增加查询执行日志记录
- 完善错误处理机制

### v1.0.2 - 2023-11-12
- 添加PostgreSQL支持
- 改进查询执行时间统计
- 修复数据源ID验证逻辑

### v1.0.1 - 2023-11-10
- 初始版本发布
- 支持MySQL数据源管理
- 基本查询功能实现